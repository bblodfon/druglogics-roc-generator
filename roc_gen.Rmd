---
title: "Druglogics ROC curve Generator"
author: "[John Zobolas](https://github.com/bblodfon)"
output:
  html_document:
    df_print: paged
    theme: united
    toc: true
    toc_float: true
runtime: shiny
---

# Intro

With this code we can **generate a ROC curve** from one or two ensemble-wise 
synergy files, which is one of the output results of the druglogics pipeline 
module `drabme`.

# Prerequisites

```{r Load libraries and functions, message = FALSE}
library(shiny) # 1.2.0
source("useful_fun.R") # loads `dplyr`
```

# Example Input

**Input files** that are needed in order to generate the ROC curve are:

- At least **one ensemble-wise synergy** result file
  - In case of two such files, the second is used for normalizing the results 
  of the first through various methods
- One **observed synergies file** to test against the synergies found from the 
`drabme` simulation(s)

Check in the `input/` dir for example files and their format.  
In the next section we show how to create a combined `predictions` object from
such files:
```{r Input and validation}
# Set the working directory to the druglogics-roc-generator folder: 
# setwd("pathTo/druglogics-roc-generator")

input.dir = paste0(getwd(), '/input')
original.file = paste0(input.dir, "/ensemble_synergies")
random.file = paste0(input.dir, "/ensemble_synergies_random")
observed.synergies.file = paste0(input.dir, "/observed_synergies")

# load files
observed.synergies = get.observed.synergies(observed.synergies.file)
orig.res = read.ensemble.synergies.drame.file(original.file)
rand.res = read.ensemble.synergies.drame.file(random.file)

data.validation(orig.res, rand.res, observed.synergies)
predictions.example = 
  create.predictions.data.frame(orig.res, rand.res, observed.synergies)
```

You can of course use the rest of the code if you can create a `predictions` 
object yourself (with at least one of the `original` or `random` columns).  
Get a glimpse of the `predictions` data:
```{r, echo = FALSE}
numericInput("rows", "How many rows to show?", 5)

renderTable({
  head(predictions.example, n = input$rows)
}, digits = 7)
```

# Scaling/Normalization

In order to generate ROC curves some scaling/normalization of the single and/or 
combined ensemble-wise synergy score results needs to be done. The main methods 
used are:

- Single exponentation (scaling)
  - **exp-orig**: $original\Rightarrow exp(original)$
  - **exp-rand**: $random\Rightarrow exp(random)$
- Combined exponentation (normalization)
  - **exp-prod-norm**: $orig\cdot rand\Rightarrow exp(orig)\cdot exp(rand)=exp(orig+rand)$
  - **exp-fold-change-norm**: $orig/ rand\Rightarrow exp(orig)/ exp(rand)=exp(orig-rand)$

# Create ROC Curve

Choose a normalization method and input files (at least one drabme file is 
needed, otherwise the example input is used from above) to draw the ROC curve:
```{r, echo = FALSE}
# Input section
selectInput(inputId = "method", label = "Select Method", 
            choices = c("original", "random", "exp-orig", "exp-rand", 
                        "exp-prod-norm", "exp-fold-change-norm"))

fileInput(inputId = "observed", label = "Select Observed Synergies File", 
          buttonLabel = "Browse...", placeholder = "No file selected")
fileInput(inputId = "orig", label = "Select Original Ensemble Synergies File", 
          buttonLabel = "Browse...", placeholder = "No file selected")
fileInput(inputId = "rand", label = "Select Random Ensemble Synergies File", 
          buttonLabel = "Browse...", placeholder = "No file selected")

# drawing section
renderPlot({
  # take input
  method = input$method
  observed.synergies.file = input$observed$datapath
  original.file = input$orig$datapath
  random.file = input$rand$datapath
  
  # decide on the `predictions` object
  if (!is.null(observed.synergies.file) & (!is.null(original.file) | 
                                           !is.null(random.file))) {
    # we generate new `predictions`
    observed.synergies = get.observed.synergies(observed.synergies.file)
    orig.res = read.ensemble.synergies.drame.file(original.file)
    rand.res = read.ensemble.synergies.drame.file(random.file)
    
    data.validation(orig.res, rand.res, observed.synergies)
    predictions = create.predictions.data.frame(orig.res, rand.res, observed.synergies)
  }
  else {
    # use example `predictions`
    predictions = predictions.example
  }
  
  method.check(method, predictions)
  
  # analyze predictions
  
  # pre = arrange(predictions, !!method)
  # thres.values = select(predictions, exp.prod.norm)
  
  # output ROC
  
})
```